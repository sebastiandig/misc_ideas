---
title: "Check CTD Data Station Names"
author: "Sebastian Di Geronimo"
date: 2025-08-28
format: html
editor: source
---

# 1.0 ---- Summary of Document ----



# 2.0 ---- Setup ----


## 2.1 Load Libraries

```{r setup, include=FALSE}
if (!nzchar(system.file(package = "librarian"))) 
  install.packages("librarian")

librarian::shelf(
  quiet = TRUE,
  librarian, conflicted, ggplot2, tibble, tidyr, readr, purrr, dplyr, stringr,
  forcats, lubridate, glue, fs, magrittr, here,
  
  # additional
  
)

conflicts_prefer(
  dplyr::filter(), 
  dplyr::select()
  )
  

```

## IGNORE 2.2 Load Dataset
Go to Section 3

```{r load-data}
if (FALSE) {
  file_paths <- rstudioapi::selectDirectory()
  
  dat3 <-
    file_paths %>%
    dir_ls(regexp = "\\.csv") %>%
    tibble(file = .) %>%
    
    # slice(20:22) %>%
    # slice_sample(prop = 0.1) %>%
    mutate(
      file = as.character(file),
      data = imap(
        file,
        \(.x, idx) {
          print(glue("{idx}: {basename(.x)}"))
          read_csv(.x, show_col_types = FALSE, 
                   col_types = cols(.default = col_character())) %>%
          select(station, cruise_id, latitude, longitude) %>%
          distinct()
          
          }
        )
    ) %T>% 
    print()


  ctd_fix_nm <-
    dat3 %>%
    unnest(data) %>%
    distinct(cruise_id, station) %>%
    # arrange(station) %>%
    mutate(
      stn = str_remove(station, "WB22215\\."),
      stn = str_remove(stn, "^\\.0{1,2}|^\\.|^0{1,2}"),
      stn = if_else(str_detect(stn, "LK|^21"), "21LK", stn),
      stn = str_replace(stn, "MR.REDO", "MR"),
      stn = str_replace(stn, "TB1_RECAST", "TB1B"),
      stn = str_replace(stn, "_(\\d)$", ".\\1"),
      stn = str_replace(stn, "(CAL)(0)(\\d)", "\\1\\3"),
      stn = str_replace(stn, "225", "22.5"),
      stn = str_replace(stn, "675", "6.75"),
      stn = str_replace(stn, "7.B", "7B"),
      stn = str_replace(stn, "57.3.2", "57.3B"),
      stn = str_replace(stn, "AM1", "AMI"),
      stn = str_replace(stn, "1016", "16"),
      stn = str_replace(stn, "116", "16"),
      stn = str_replace(stn, "117", "17"),
      stn = str_replace(stn, "120", "20"),
      stn = str_replace(stn, "95", "9.5"),
      stn = case_when(
        str_detect(stn, "DT0") ~ str_replace(stn, "DT0", "DT"),
        str_detect(stn, "DT") ~ str_remove(stn, "\\."),
        str_detect(stn, "EH") ~ str_replace(stn, "EH0", "EH"),
        .default = stn
      ),
      stn = case_when(
        str_detect(cruise_id, "WS0914") ~ str_replace(stn, "65", "6.5"),
        .default = stn
      )
    )

  ctd_fix_nm %>%
    arrange(stn) %T>%
    print() %>%
    slice(1001:n()) %>%
    print() %>%
    slice(1001:n()) %>%
    print() %>%
    slice(1001:n()) %>%
    print()
  filter(station != stn) %>%
    distinct(station, stn)
  filter(str_detect(station, "65"))

  ctd_fix_nm %>%
    distinct(station, stn) %>%
    write_csv(here("data", "processed", "ctd_station_name_map.csv"))

  ctd_fix_nm %>%
    write_csv(here("data", "processed", "ctd_all_station_name_map.csv"))
}
```


```{r}
 file_paths %>%
  dir_ls(regexp = "\\.csv")
```


1016
116
117
120
15.5SURFACE
15_5
205
225A
30B
33UP
495
57.3.2
675

```{r}
stn16 <- "C:/Users/spd19/Box/mbon_imars_cruises/ctd_data/cleaned_ctd_data/WS23061.csv" %>%
 read_csv(show_col_types = FALSE) %>%
  distinct(station, latitude, longitude) %>%
  filter(str_detect(station, "16"))

# show 6.5 as 65
"C:/Users/spd19/Box/mbon_imars_cruises/ctd_data/cleaned_ctd_data/WS0914.csv" %>%
 read_csv(show_col_types = FALSE) %>% 
  distinct(station, latitude, longitude) %>%
    # filter(str_detect(station, "1")) %>%
  # arrange(time_elapsed)
 ggplot(aes(x = longitude, y = latitude)) +
  geom_point() +
  ggrepel::geom_label_repel(aes(label = station), max.overlaps = 100, min.segment.length = 0) +
  # geom_point(data = stn16, color = "red") +
  # ggrepel::geom_label_repel(data = stn16, aes(label = station), max.overlaps = 100, min.segment.length = 0, color = "red") +
  theme_bw()
```

```{r}
ylim <- range(unnest(dat3, data)$latitude) |> as.numeric() 
xlim <- range(unnest(dat3, data)$longitude) |> as.numeric() 

base_plt <- 
  rnaturalearth::ne_coastline(10, "sf") %>%
  ggplot() +
  geom_sf(color = "grey50") +
  coord_sf(xlim = xlim, ylim = ylim) +
  labs(x = NULL, y = NULL)
base_plt
dat3 %>%
  # slice(1:3) %>%
  # unnest(data)
  mutate(
    
  plt = map(
    data,
    \(.dat) {
      plt <- 
        
       dat2 <-  .dat %>%
      hablar::retype()
      
      base_plt +
      # ggplot(aes(x = longitude, y = latitude, label = station)) +
  geom_point(data = dat2, aes(x = longitude, y = latitude, label = station)) +
  ggrepel::geom_label_repel(data = dat2, aes(x = longitude, y = latitude, label = station),
                            max.overlaps = 100, min.segment.length = 0) +
  theme_bw() +
        facet_grid(~cruise_id) 
      }
        )
  ) %>%
  pull(plt) 
%T>%
  print() %>%
  map(
    ~ plotly::ggplotly(.x)
  )

camcorder::gg_record(here("data", "plots", "ctd_cam_fix"))
```

```{r}
dat3 %>%
  unnest(data) %>%
  # distinct(cruise_id, station) %>%
  # arrange(station) %>%
  mutate(
    stn = str_remove(station, "WB22215\\."),
    stn = str_remove(stn, "^\\.0{1,2}|^\\.|^0{1,2}"),
    stn = if_else(str_detect(stn, "LK|^21"), "21LK", stn),
    stn = str_replace(stn, "MR.REDO", "MR"),
    stn = str_replace(stn, "TB1_RECAST", "TB1B"),
    stn = str_replace(stn, "_(\\d)$", ".\\1"),
    stn = str_replace(stn, "(CAL)(0)(\\d)", "\\1\\3"),
    stn = str_replace(stn, "225", "22.5"),
    stn = str_replace(stn, "675", "6.75"),
    stn = str_replace(stn, "7.B", "7B"),
    stn = str_replace(stn, "57.3.2", "57.3B"),
    stn = str_replace(stn, "AM1", "AMI"),
    stn = str_replace(stn, "1016", "16"),
    stn = str_replace(stn, "116", "16"),
    stn = str_replace(stn, "117", "17"),
    stn = str_replace(stn, "120", "20"),
    stn = str_replace(stn, "95", "9.5"),
    stn = case_when(
      str_detect(stn, "DT0") ~ str_replace(stn, "DT0", "DT"),
      str_detect(stn, "DT") ~ str_remove(stn, "\\."),
      str_detect(stn, "EH") ~ str_replace(stn, "EH0", "EH"),
      .default = stn
    ),
    stn = case_when(
      str_detect(cruise_id, "WS0914") ~ str_replace(stn, "65", "6.5"),
      .default = stn
    )
    
    
  ) %>%
  nest(.by = file)  %>%
  mutate(
    
  plt = map(
    data,
    \(.dat) {
      plt <- 
        
       dat2 <-  .dat %>%
      hablar::retype()
      
      base_plt +
      # ggplot(aes(x = longitude, y = latitude, label = station)) +
  geom_point(data = dat2, aes(x = longitude, y = latitude, label = stn)) +
  ggrepel::geom_label_repel(data = dat2, aes(x = longitude, y = latitude, label = stn),
                            max.overlaps = 100, min.segment.length = 0) +
  theme_bw() +
        facet_grid(~cruise_id) 
      }
        )
  ) %>%
  pull(plt) 
```

# -------------------------------
# START HERE: 
# -------------------------------

# 3.0 Search through TAMU ERRDAP

```{r libs}
shelf(rerddap, cli, parzer)
```

## Set database Website

Once you find an ERDDAP with the data you want, you can change the location here

TAMU ERDDAP publishes the CTD data from the SFP/MBON cruises
- "https://gcoos5.geos.tamu.edu/erddap/"

PFEG ERDDAP (not used)
- "https://upwell.pfeg.noaa.gov/erddap/" 
- contains meteorological data
  - wanted to use
    - wind speed 
    - Ekman transport

```{r set-database}
# this database contains CTD data from Walton Smith Cruises
"https://gcoos5.geos.tamu.edu/erddap/" %>%
  Sys.setenv(RERDDAP_DEFAULT_URL = .)
```

## Qery ERDDAP for CTD Data and Compare to Cruise IDs from Pigment Data

Research vessel acronym:
  - WS = R/V Walton Smith (majority)
  - SAV = R/V Savannah
  - WB = R/V Weatherbird II
  - H = 
  
NOTE: some cruise IDs were modified because there is some slight difference in 
      IDs during the same cruise. This is usually due to a delay in cruise start
      date and was not changed prior to departure.
      
      
```{r query-erddap-cruise-id}
# # folder path to save downloaded and average CTD data
# dir_data_dwnld_save <- here("data", "raw", "ctd")       # download path
# dir_data_avg_save   <- here("data", "processed", "ctd") # averaged path
# 
# dir_create(dir_data_avg_save)

# all cruises prior to 2016
# this covers all possible cruises to download more than necessary
all_cruise_info <-
  ed_search_adv(
    query     = "Walton Smith",
    maxTime   = "2025-01-01T01:00:00Z",
    page_size = 10000
  )

all_cruise_ids <-
  str_extract(all_cruise_info$info$title, "(WS|SAV|WB|H|HG)\\d{3,5}") %>%
  unique()



# ---- print info about cruise IDs found
cli::cli_alert_info(
  c(
    "{col_green(\"Number of files queried\")}: ",
    "{nrow(all_cruise_info$info)} files\n",
    "{col_blue(\"Cruise IDs\")}:\n{all_cruise_ids}\n\n"
  )
)

```

## Separate results info into tab delim results

```{r}
cruis_id <- 
  all_cruise_info$info %>%
  separate_wider_delim(title, delim = ", ", names_sep = "_") %T>%
  print() %>%
  mutate(
    .before = title_5,
    title_5 = str_replace(title_5, " 82W", " 82.0W"),
    lat_lon = parse_llstr(title_5),
    station = str_to_upper(title_3),
    station = str_remove(station, " "),
    station = str_replace(station, "WS20278", "WS20279"),
    station = str_replace(station, "WS21277", "WS21278"),
    station = str_replace(station, "WS23011", "WS23010"), # weird
    station = str_remove_all(station, "_AUG_2011_|2022_08_WEATHERBIRD_SMITH_CTD_|KELBLE_|HEX|SFP_"),
    station = str_remove_all(station, title_2),
    station = str_remove(station, "^_-|^_{1,2}"),
    station = str_remove(station, "^\\."),
    station = str_remove(station, "\\s?(^STA|^STN)\\.?_?"),
    station = str_remove(station, "^0{1,2}"),
    station = str_replace(station ,"(UK|EK|Z\\d{2})(_|-)(.*)", "\\1\\3"),
    station = str_replace(station ,"_", "."),
    station = str_replace(station, "(DT)0(\\d{1,2})", "\\1\\2"),
    station = str_replace(station, "(^\\d{1,2})-(\\d{1,2})", "\\1.\\2"),
    station = if_else(str_detect(station, "LK|^21$"), "21LK", station),
    date    = as_date(title_4)
  ) %>%
  unnest(lat_lon) %>%
  arrange(date) %>%
  rename("cruise_id" = title_2) %T>% 
  print() %>%
 select(
   dataset_id, 
   cruise_id,
   date, 
   lon, lat,
   station,
  ) %>% 
  mutate(
   cruise_id_og = cruise_id,
   station_og  = station
  ) %>%
  relocate(cruise_id_og, .before = cruise_id) %>% 
  relocate(station_og, .before = station) %T>% 
  print()
```

```{r}
# shelf(camcorder)
# camcorder::gg_record(
#   dir    = here::here("data", "cam_test", "ctd_stn_check"),
#   device         = "png",
#   bg             = "white",
#   dpi = 600
# )

# shell.exec(here::here("data", "cam_test", "ctd_stn_check"))
# camcorder::gg_stop_recording()

# avg_ctd <- rstudioapi::selectFile()
avg_ctd <- here("~/Downloads/Station_Mean_Coords.csv")  %>%
  read.csv() %T>% 
  print()

base_plt <-
  ggplot() +
  geom_sf(
    data = rnaturalearth::ne_coastline(10, "sf"),
    alpha = 0.5
  ) +
  geom_point(
    data = avg_ctd,
    aes(
      y = lat_mean, x = lon_mean,
      label = station,
      color = rel_loc
    ),
    shape = 21
  )

  



for (i in distinct(cruis_id, cruise_id)$cruise_id) {
  # filter for one cruise at a time
  datas <- filter(cruis_id, cruise_id == i)

  # extract cruise Id and start date
  cruise <- datas$cruise_id[1]
  date_lb <- min(datas$date)

  # lat/lon limits
  ylimt <- c(24, max(datas$lat) + 0.25)
  xlimt <- c(min(datas$lon) - 0.25, -79.5)


  # combine avg station locations with CTD station locations
  ctd_labels <-
    bind_rows(
      mutate(avg_ctd, ctd = "labels"),
      select(datas, "station" = station, "lat_mean" = lat, "lon_mean" = lon, ) %>%
        mutate(ctd = "stations")
    ) %>%
    filter(
      between(lat_mean, ylimt[1], ylimt[2]) &
        between(lon_mean, xlimt[1], xlimt[2])
    )

  # plot stations
  print(glue("{cruise}: {date_lb}"))
  print(
    base_plt +
      geom_point(
        data = datas,
        aes(x = lon, y = lat, label = station),
        size = 0.3
      ) +

      ggrepel::geom_text_repel(
        data = ctd_labels,
        aes(x = lon_mean, y = lat_mean, label = station, color = ctd),
        max.overlaps       = 100,
        size               = 1,
        alpha              = 0.75,
        min.segment.length = 0,
        segment.size       = 0.2
      ) +
      labs(
        title = glue("{cruise}: {date_lb}"),
        x = NULL,
        y = NULL,
        color = NULL
      ) +
      scale_color_manual(
        values = c(
          "keys" = "lightblue", "south" = "green", "west" = "orange",
          "stations" = "blue", "labels" = "black"
        )
      ) +
      coord_sf(ylim = ylimt, , xlim = xlimt, expand = FALSE, clip = "on") +
      theme_bw() +
      theme(
        legend.position = "inside",
        legend.position.inside = c(0.7, 0.85)
      )
  )
}
```


```{r}
# distinct(cruis_id, title_2) %>%
#   writexl::write_xlsx(here("data", "cam_test", "ctd_stn_check", "ctd_check.xlsx"))

cruis_id %>%
 select(
   dataset_id, 
   "cruise_id_og" = cruise_id,
   cruise_id,
   date, 
   lon, lat,
   station,
   "station_og" = station
  )
  writexl::write_xlsx(here("data", "cam_test", "ctd_stn_check", "ctd_datasetid2.xlsx"))
  
```





