---
title: "Fresca Map"
author: "Sebastian Di Geronimo"
date: 2025-06-04
format: html
editor: source
---

# 1.0 ---- Summary of Document ----

This document is to create a map of the sampling locations and type for the
FRESCA project. 

All that's required is to have the adjoining `mapping_script.R` to download 
the topography and coastline data, pull the objects to memory and create
a base map to add points to.



# 2.0 ---- Setup ----


## 2.1 Load Libraries

```{r setup, include=FALSE}
if (!nzchar(system.file(package = "librarian"))) 
  install.packages("librarian")

librarian::shelf(
  quiet = TRUE,
  librarian, conflicted, ggplot2, tibble, tidyr, dplyr, stringr,
  glue, fs, magrittr, here,
  
  # additional
  ggrepel, ggnewscale, janitor, readxl, rerddap, rlang, terra, metR,
  cowplot
  
)

conflicts_prefer(
  dplyr::filter(), 
  dplyr::select()
  )
  
source(here("scripts", "mapping_script.R"))

```


## 2.2. Locate Site Data

The file needs to be in the same folder that this file is located.

Site File name: `sfer_sta_list_Multistressor.xlsx`

Select a location for the downloads of topography and coastline data:
Use the form:
here("<first folder>", "<second folder>", "<ect>")

```{r path-to-data}
# locate the data file
map_file <- 
  here() %>%
  dir_ls(regexp = "sfer_sta_list_Multistressor", recurse = TRUE)


# path to add base map files
  # map_loc <- here("data", "map_shp")
  map_loc <- rstudioapi::selectDirectory()
  map_topo <- here("data", "map_shp", "fresca")

```


## 2.3 Load Site Data


```{r load-data}
# load file
map_dat <- 
  readxl::read_excel(map_file) %>%
  janitor::clean_names() %>%
  mutate(
    description = if_else(is.na(description), "CTD", description)
    ) %T>% 
  print()

# extract net tows and incubation locations
zoo_incubation <-
  map_dat %>%
  filter(str_detect(description, "Net")) %>%
  separate_longer_delim(
    description,
    delim = "/"
  ) %>%
  filter(
    !str_detect(description, "CTD")
   & !str_detect(description, "200")
   & !str_detect(description, "Incubation")
   ) %>%
  mutate(
    description = str_replace(description, "500", "500/200 um)"),
    description = paste(description, "Incubation", sep = "/")
  ) %T>%
  print()

# remove net tows and incubations from CTD and flow through locations
map_dat <- 
  map_dat %>%
  separate_longer_delim(
    description,
    delim = "/"
  ) %>%
  filter(str_detect(description, "CTD|Flow")) %>%
  mutate(description = if_else(
    !is.na(trace_metals),
    paste(description, trace_metals, sep = "/"),
    description
    )) %T>% 
  print()
```




# 3.0 ---- Base Map Data ----

Topography, ETOPO1, 0.0166667 degrees, Global (longitude -180 to 180), (Ice 
Sheet Surface) from https://coastwatch.pfeg.noaa.gov/erddap/griddap/

Global Self-consistent, Hierarchical, High-resolution Geography Database (GSHHG)
from https://www.ngdc.noaa.gov/mgg/shorelines/

Edit the spatial extent below if needed a bigger map:
exnt <- 
  c(
    xmin =  , # West
    xmax = ,                         # East
    ymin = ,                          # South
    ymax =    # North 
    )
  

```{r base-map}
if (exists("base_plt")) {
  
  cli::cli_alert_info("{.var base_plot} is already loaded!")
  
} else {
  
  # spatial extent
  exnt <- 
    c(
      xmin =  min(map_dat$dec_lon) - 0.2, # West
      xmax = -80,                         # East
      ymin = 24,                          # South
      ymax = max(map_dat$dec_lat) + 0.2   # North 
      )
  
  
  ## ---- download topography (.nc) and coastline (.shp)
  world_download(
    path_land  = map_loc,
    path_topo  = map_topo,
    extent     = exnt,
    use_suffix = NULL,
    .timeout = 300     # may need to increase if download of GSHHG fails
  )
  
  ## ---- Load Base Maps for Plotting
  # select and read coastline file from GSHHS then crop
  map_obj <-
    load_map_obj(
      .map_coast = map_loc,
      .map_state = NULL,
      .map_bath  = map_topo,
      .map_file  = "etopo1.nc",
      .extent    = exnt
    )

  ## ---- Plot Base Map
  base_plt <-
    base_map_plot(
      .topo     = map_obj$coast_topo, 
      # .bathy    = rename(map_obj$bathy, "altitude" = z), 
      .bathy    = rename(map_obj$bathy, "altitude" := any_of("z")), 
      .extent   = exnt,
      .breaks_z = c(1000, 500, 100, 50, 25, 10)
      )
  base_plt
}
```

# ---- Map Sample Locations ----

## Plot Map


```{r add-stations, fig.width=8.5, fig.height=11}
# change colors 
colors_sel <- 
  c("Flow Through"              = "#1f78b4", 
    "CTD/Trace Metals"          = "#FF3030", 
    "CTD"                       = "forestgreen", 
    "Net Tow (64um)/Incubation" = "#1f78b4",
    "Net Tow (64 um + 500/200 um)/Incubation" = "#FF3030"
    )

set.seed(123)
fresca_map <- 
  
  # ---- base map ---- #
  base_plt +
  
  # ---- Zooplankton ---- #
  geom_point(
    data  = zoo_incubation,
    aes(
      x     = dec_lon,
      y     = dec_lat,
      color = description
    ),
    stroke = 1,
    shape  = 5,
    size   = 2.5
  ) +
  # labs(color = "Zooplankton Mesh Size") +
  scale_color_manual(
    name   = "Samples",
    values = colors_sel
    ) +
  
  
  # ---- Site Locations ---- #
  new_scale_color() +
  geom_point(
    data = map_dat,
    aes(
      x     = dec_lon, 
      y     = dec_lat, 
      color = description,
      shape = description),
  ) +
    
  
  
  # ---- Site Names ---- #
  geom_text_repel(
    data  = map_dat,
    aes(
      x             = dec_lon,
      y             = dec_lat,
      label         = waypoint,
      segment.color = "gray"
        ),
    size     = 1.5,
    hjust    = 0,
    family   = "serif",
    bg.color = "white",
    min.segment.length = 0,
    oob = scales::oob_discard
  ) +
  scale_color_manual(
    name   = "Samples",
    values = colors_sel
    ) +
  labs(shape = "Samples") + 
  
  
  # ---- theme --- #
  theme(
    legend.position        = "inside",
    legend.position.inside = c(0.2, 0.14),
    legend.text            = element_text(size = 10),
    legend.title           = element_text(size = 15),
    legend.background      = element_rect(color = "black")
  )

fresca_map
```
```{r, fig.width=8.5, fig.height=11}
fresca_map + 
  coord_sf(xlim = c(-82, -80), ylim = c(24.3, 25)) +
  guides(fill = "none", color = "none", shape = "none")

base_plt + 
  coord_sf(xlim = c(-82, -80), ylim = c(24.3, 25))


map_obj2$bathy %>%
  ggplot(aes(x = x, y = y, fill = z)) +
  geom_tile() +
  scale_fill_viridis_b(breaks = -c(1, 25, 50, 100, 200, 500, 1000, 2000)) +
  labs(title = "2022") + 
  coord_cartesian(xlim = c(-82, -80), ylim = c(24.3, 25))
```


# Save Map

```{r}
# save map
 cowplot::save_plot(
  here("data", "fresca_map3.png"),
  plot        = fresca_map,
  dpi         = 600,
  base_width  = 8.5,
  base_height = 11
 )
```


# Plot CREMP Data with SFER/MBON

```{r gdb-path}
# fresca_map +
#   ggnewscale::new_scale_fill() +
#   geom_sf(data = layer_sf, aes(color = Habitat)) +
#   coord_sf(ylim = c(NA, 25.5), clip = "on", xlim = c(-83, -80)) +
#   guides(shape = "none", color = "none", fill = "none")


cremp_gdb <- 
  here("data", "raw") %>%
  dir_ls(regexp = "CREMP") %>%
  dir_ls()


# see what layers are available
cremp_lyrs <- st_layers(cremp_gdb)
cremp_lyrs$name

# read one layer (replace "LayerName" with a name from st_layers)
layer_sf <- st_read(cremp_gdb, layer = "CREMP_Stations_pnt_Albers") %>%
  st_transform(crs(map_obj$coast_topo))

# plot(layer_sf["Site_Code"])

# ggplot() +
#   geom_sf(data = layer_sf, aes(color = Habitat, shape = Habitat)) 

base_plt +
  geom_sf(data = layer_sf, aes(color = Habitat), shape = 21, size = rel(5),
          stroke = rel(1.2)) +
  scale_color_viridis_d() +
  new_scale_color() +
  geom_point(
    data = map_dat,
    aes(
      x     = dec_lon, 
      y     = dec_lat, 
      color = description,
      shape = description),
    size = rel(3)
  ) + 
  scale_color_manual(
    name   = "Samples",
    values = colors_sel
    ) +
   labs(shape = "Samples") +
  coord_sf(ylim = c(24.35, 25.5), clip = "on", xlim = c(-82.2, -80)) +
  theme(legend.position = "bottom")

if (FALSE) {
  # save map
  cowplot::save_plot(
    here("data", "plots", "sfer_cremp.png"),
    plot        = last_plot(),
    dpi         = 600,
    base_width  = 11,
    base_height = 8.5
  )
}
```







```{r}
Sys.setenv(RERDDAP_DEFAULT_URL = "https://coastwatch.pfeg.noaa.gov/erddap/")
  ## ---- download topography (.nc) and coastline (.shp)
  world_download(
    path_land  = map_loc,
    path_topo  = here(map_topo, "..", "etopo2022"),
    extent     = exnt,
    use_suffix = NULL,
    .timeout = 300,     # may need to increase if download of GSHHG fails
    etopo_version = "ETOPO_2022_v1_15s"
  )
Sys.unsetenv("RERDDAP_DEFAULT_URL")
```

```{r}
 map_obj <-
    load_map_obj(
      .map_coast = map_loc,
      .map_state = NULL,
      .map_bath  = here(map_topo, "..", "etopo2022"),
      .map_file  = "ETOPO_2022_v1_15s.nc",
      .extent    = exnt
    )

map_obj$bathy %>%
  ggplot(aes(x = x, y = y, fill = z)) +
  geom_tile() +
  scale_fill_viridis_b(breaks = -c(1, 100, 200, 500, 1000, 2000)) +
  labs(title = "2022")

map_obj$bathy %>%
  ggplot(aes(x = x, y = y, fill = altitude)) +
  geom_tile() +
  scale_fill_viridis_b(breaks = -c(1, 100, 200, 500, 1000, 2000)) 

map_obj2$bathy
map_obj$bathy

ggplot(
  map_obj$bathy,
  aes(
    x = x,
    y = y,
    z = -z
  ),
) +
  metR::geom_contour2(
    col    = "grey70",
    breaks = c(1, 100, 200, 500, 1000, 2000)
  ) +
  theme_bw() +
  theme(
    text = element_text(family = "serif", size = 10),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  ) +
  metR::geom_text_contour(breaks = c(1, 100, 200, 500, 1000, 2000)) +
  coord_cartesian(xlim = c(-82, -81), ylim = c(24, 25)) 


```

```{r}
rerddap::ed_search("etopo5", url = "https://pae-paha.pacioos.hawaii.edu/erddap/")
rerddap::ed_search("etopo", url = "https://coastwatch.pfeg.noaa.gov/erddap/")
rerddap::ed_search("etopo")
```

```{r}
a <- -2
b <- +2
n <- 150
x <- runif(n * n, a, b)
y <- runif(n * n, a, b)
df <- data.frame(x, y)
df$z <- with(df, -x * y * exp(-x^2 - y^2))
df.sub <- subset(df, x^2 + y^2 < 2)


df.cnt <- getContourLines(df.sub, nlevels = 20)
# df.cnt <- getContourLines(slice_sample(map_obj$bathy, prop = 0.8), nlevels = 5)
ggplot(data = df.cnt, aes(x, y, group = Group, colour = z)) +
  geom_path() +
  theme_bw()


Mag(10, -10)
Angle(10, -10)



```


```{r}
shelf(sf)

topo_rast <- 
  map_topo  %>%
  dir_ls() %>%
    terra::rast()

pts_sf <-
  map_dat %>%
  filter(
    str_detect(description, "CTD"),
    (waypoint < 30 | str_detect(waypoint, "MR|LK|WS"))
    ) %>%
  filter(!str_detect(waypoint, "16|10")) %>%
  arrange(dec_lon) %>%
  st_as_sf(coords = c("dec_lon", "dec_lat"), crs = 4326) %T>% 
  print()
  
line_sf <- 
  pts_sf %>%
  summarise(do_union = FALSE) %>%
  st_cast("LINESTRING") %>%
  st_transform(crs = crs(topo_rast)) %>%
  vect()

plot(line_sf)

topo_along <- extractAlong(topo_rast, line_sf, xy = TRUE)

topo_along %>%
  mutate(
    x2 = dplyr::lag(x),
    y2 = dplyr::lag(y),
    dist = geosphere::distHaversine(
      cbind(x, y),
      cbind(x2, y2)
    ),
    dist = if_else(is.na(dist), 0, dist) / 1000,
    dist_cum = cumsum(dist)
  ) %>%
  ggplot(aes(x = dist_cum, y = altitude)) +
  geom_line()

plot(line_sf)


(ggplot() +
  tidyterra::geom_spatraster(data = topo_rast) +
  geom_sf(data = line_sf, color = "red") +
  coord_sf(xlim = c(-82, -80), ylim = c(NA, 25.5)) +
  scale_fill_gradientn(
    colors = oce::oce.colorsViridis(120),
    limits = c(-100, 20),
    oob = scales::oob_squish
    )) %>%
  plotly::ggplotly()

```

